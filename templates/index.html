<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8" />
    <title>WebinarHunt</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body {
            background-color: #020617;
        }

        /* slate-950 */
    </style>
</head>

<body class="h-full text-slate-100">
    <script>
        // Hydrate initial data from Flask
        window.INITIAL_WEBINARS = {{ webinars | tojson }};
    </script>

    <div class="min-h-full" x-data="webinarsApp()">
        <!-- Sticky header -->
        <header class="sticky top-0 z-20 border-b border-slate-800 bg-slate-950/95 backdrop-blur">
            <div class="max-w-6xl mx-auto px-4 py-3 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                <div class="space-y-0.5">
                    <h1 class="text-lg sm:text-xl font-semibold tracking-tight">WebinarHunt</h1>
                    <p class="text-xs text-slate-400">
                        Prioritize SANS webinars by duration, freshness, CySA+ relevance, and what youâ€™ve actually
                        watched.
                    </p>
                </div>
                <div class="flex flex-col items-start sm:items-end text-[11px] text-slate-400 gap-1">
                    <div>
                        Total: <span class="font-semibold text-slate-100" x-text="allWebinars.length"></span>
                        &nbsp;&bull;&nbsp;
                        Showing: <span class="font-semibold text-slate-100" x-text="sortedWebinars.length"></span>
                    </div>

                    <!-- Mobile filters toggle -->
                    <button type="button"
                        class="inline-flex items-center gap-1 px-2 py-1 rounded-full border border-slate-600 bg-slate-900 text-[11px] sm:hidden"
                        @click="showFilters = !showFilters">
                        <span class="material-symbols-outlined text-xs" aria-hidden="true">tune</span>
                        <span x-text="showFilters ? 'Hide filters' : 'Show filters'"></span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main content -->
        <main class="max-w-6xl mx-auto px-4 py-4 space-y-4">
            <!-- Search + Sort -->
            <section class="bg-slate-900/80 border border-slate-800 rounded-xl p-3 sm:p-4 space-y-3">
                <div class="flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
                    <!-- Search -->
                    <div class="w-full md:flex-1">
                        <label class="block text-[11px] font-medium text-slate-400 mb-1">Search</label>
                        <div class="relative">
                            <input type="text" x-model="searchTerm"
                                placeholder="Search by title, description, CySA+ tag, focus areaâ€¦" class="w-full bg-slate-950 border border-slate-700 rounded-lg pl-9 pr-3 py-2 text-sm
                       focus:outline-none focus:ring-1 focus:ring-sky-500 focus:border-sky-500" />
                            <span class="absolute inset-y-0 left-2 flex items-center text-slate-500 text-sm">ðŸ”Ž</span>
                        </div>
                    </div>

                    <!-- Sort -->
                    <div class="w-full md:w-64">
                        <label class="block text-[11px] font-medium text-slate-400 mb-1">Sort by</label>
                        <select class="w-full bg-slate-950 text-slate-100 text-sm rounded-lg px-3 py-2 border border-slate-700
                     focus:outline-none focus:ring-1 focus:ring-sky-500" x-model="sortMode">
                            <option value="duration">Duration (bucket â†’ newest â†’ title)</option>
                            <option value="title">Title (A â†’ Z)</option>
                            <option value="watched">Watched status</option>
                            <option value="relevance">Relevance (CySA+ / favorites / newer)</option>
                            <option value="recent_created">Recently created (newest first)</option>
                        </select>
                    </div>
                </div>

                <!-- Filters -->
                <div class="border-t border-slate-800 pt-3 mt-2 space-y-3" x-show="showFilters" x-transition>
                    <!-- Duration -->
                    <div class="flex flex-wrap gap-2 items-center text-[11px]">
                        <span class="text-slate-400 mr-1">Duration:</span>

                        <button type="button" @click="durationFilter = 'all'" :class="durationFilter === 'all'
                ? 'bg-sky-500 text-slate-950 border-sky-400'
                : 'bg-slate-800 text-slate-100 border-slate-600 hover:bg-slate-700'"
                            class="px-2.5 py-1 rounded-full border">All</button>

                        <button type="button" @click="durationFilter = 'under1'" :class="durationFilter === 'under1'
                ? 'bg-sky-500 text-slate-950 border-sky-400'
                : 'bg-slate-800 text-slate-100 border-slate-600 hover:bg-slate-700'"
                            class="px-2.5 py-1 rounded-full border">&lt; 1h</button>

                        <button type="button" @click="durationFilter = 'approx1'" :class="durationFilter === 'approx1'
                ? 'bg-sky-500 text-slate-950 border-sky-400'
                : 'bg-slate-800 text-slate-100 border-slate-600 hover:bg-slate-700'"
                            class="px-2.5 py-1 rounded-full border">â‰ˆ 1h</button>

                        <button type="button" @click="durationFilter = 'approx2'" :class="durationFilter === 'approx2'
                ? 'bg-sky-500 text-slate-950 border-sky-400'
                : 'bg-slate-800 text-slate-100 border-slate-600 hover:bg-slate-700'"
                            class="px-2.5 py-1 rounded-full border">â‰ˆ 2h</button>

                        <button type="button" @click="durationFilter = 'three_plus'" :class="durationFilter === 'three_plus'
                ? 'bg-sky-500 text-slate-950 border-sky-400'
                : 'bg-slate-800 text-slate-100 border-slate-600 hover:bg-slate-700'"
                            class="px-2.5 py-1 rounded-full border">&ge; 3h</button>
                    </div>

                    <!-- Watched -->
                    <div class="flex flex-wrap gap-2 items-center text-[11px]">
                        <span class="text-slate-400 mr-1">Watched:</span>

                        <button type="button" @click="watchedFilter = 'all'" :class="watchedFilter === 'all'
                ? 'bg-sky-500 text-slate-950 border-sky-400'
                : 'bg-slate-800 text-slate-100 border-slate-600 hover:bg-slate-700'"
                            class="px-2.5 py-1 rounded-full border">All</button>

                        <button type="button" @click="watchedFilter = 'unwatched'" :class="watchedFilter === 'unwatched'
                ? 'bg-sky-500 text-slate-950 border-sky-400'
                : 'bg-slate-800 text-slate-100 border-slate-600 hover:bg-slate-700'"
                            class="px-2.5 py-1 rounded-full border">Unwatched only</button>

                        <button type="button" @click="watchedFilter = 'watched'" :class="watchedFilter === 'watched'
                ? 'bg-sky-500 text-slate-950 border-sky-400'
                : 'bg-slate-800 text-slate-100 border-slate-600 hover:bg-slate-700'"
                            class="px-2.5 py-1 rounded-full border">Watched only</button>
                    </div>

                    <!-- Flags -->
                    <div class="flex flex-wrap gap-4 items-center text-[11px]">
                        <label class="inline-flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" x-model="favoritesOnly"
                                class="rounded border-slate-500 text-sky-500 bg-slate-950" />
                            <span>Favorites only</span>
                        </label>

                        <label class="inline-flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" x-model="cysaOnly"
                                class="rounded border-slate-500 text-sky-500 bg-slate-950" />
                            <span>CySA+ only</span>
                        </label>
                    </div>
                </div>
            </section>

            <!-- List -->
            <section class="space-y-3 pb-4">
                <template x-if="sortedWebinars.length === 0">
                    <div
                        class="text-sm text-slate-400 border border-dashed border-slate-700 rounded-xl px-4 py-6 text-center">
                        No webinars match your current filters. Try relaxing duration, watched, or CySA+ filters.
                    </div>
                </template>

                <template x-for="w in sortedWebinars" :key="w.objectID || w.webcastId">
                    <article
                        class="bg-slate-900 border border-slate-700 rounded-xl p-3 sm:p-4 flex flex-col gap-2 sm:gap-3">
                        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                            <div class="space-y-1.5">
                                <div class="flex items-start gap-2">
                                    <h2 class="text-sm font-semibold leading-snug" x-text="w.title"></h2>
                                    <span x-show="w.cysa_tags && w.cysa_tags.length"
                                        class="inline-flex items-center text-[9px] uppercase tracking-wide
                           bg-emerald-900 text-emerald-100 px-2 py-0.5 rounded-full border border-emerald-500">CySA+</span>
                                </div>

                                <div class="text-[11px] text-slate-300 space-x-1 flex flex-wrap items-center">
                                    <span class="font-medium" x-text="w.duration_label || 'N/A'"></span>
                                    <span>&bull;</span>
                                    <span x-text="w.startDate || 'N/A'"></span>
                                    <template x-if="w.startTime">
                                        <span>
                                            â€¢ <span x-text="w.startTime"></span>â€“<span x-text="w.endTime || ''"></span>
                                        </span>
                                    </template>
                                    <template x-if="w.type">
                                        <span> â€¢ <span x-text="w.type"></span></span>
                                    </template>
                                    <template x-if="w.createdAt">
                                        <span> â€¢ Created: <span x-text="w.createdAt"></span></span>
                                    </template>
                                </div>

                                <p class="text-[11px] text-slate-400" x-text="w.description || ''"></p>

                                <div class="flex flex-wrap gap-1 mt-1">
                                    <template x-for="tag in (w.cysa_tags || [])" :key="tag">
                                        <span
                                            class="text-[10px] bg-emerald-950 text-emerald-100 border border-emerald-700 px-2 py-0.5 rounded-full"
                                            x-text="tag"></span>
                                    </template>
                                    <template x-for="fa in (w.focusAreas || [])" :key="fa">
                                        <span
                                            class="text-[10px] bg-slate-800 text-slate-100 border border-slate-600 px-2 py-0.5 rounded-full"
                                            x-text="fa"></span>
                                    </template>
                                </div>
                            </div>

                            <!-- Right column: actions -->
                            <div
                                class="flex flex-row sm:flex-col justify-between sm:items-end gap-2 text-xs min-w-[140px]">
                                <div class="flex flex-col items-end gap-1">
                                    <a :href="w.url" target="_blank"
                                        class="inline-flex items-center gap-1 text-sky-400 hover:text-sky-300 hover:underline">
                                        Open on SANS
                                        <span aria-hidden="true">â†—</span>
                                    </a>
                                    <div class="text-[10px] text-slate-400">
                                        Bucket:
                                        <span class="font-medium"
                                            x-text="durationBucketLabel(w.duration_bucket)"></span>
                                    </div>
                                </div>

                                <div class="flex flex-row sm:flex-col gap-2 justify-end">
                                    <!-- Watched toggle -->
                                    <button type="button" @click="toggleWatched(w)" :class="w.watched
                      ? 'bg-emerald-500 text-slate-950 border-emerald-400'
                      : 'bg-slate-800 text-slate-100 border-slate-600 hover:bg-slate-700'"
                                        class="px-3 py-1 rounded-full border text-[11px] flex-1 sm:flex-none">
                                        <span x-show="w.watched">Watched âœ“</span>
                                        <span x-show="!w.watched">Mark watched</span>
                                    </button>

                                    <!-- Favorite toggle -->
                                    <button type="button" @click="toggleFavorite(w)" :class="w.favorite
                      ? 'bg-yellow-400 text-slate-950 border-yellow-300'
                      : 'bg-slate-800 text-slate-100 border-slate-600 hover:bg-slate-700'"
                                        class="px-3 py-1 rounded-full border text-[11px] flex-1 sm:flex-none">
                                        <span x-text="w.favorite ? 'â˜… Favorite' : 'â˜† Favorite'"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </article>
                </template>
            </section>
        </main>
    </div>

    <script>
        function webinarsApp()
        {
            return {
                allWebinars: window.INITIAL_WEBINARS || [],

                searchTerm: '',
                durationFilter: 'all',      // all | under1 | approx1 | approx2 | three_plus
                watchedFilter: 'all',       // all | unwatched | watched
                favoritesOnly: false,
                cysaOnly: false,
                sortMode: 'duration',       // duration | title | watched | relevance | recent_created
                showFilters: true,          // collapsible filters, especially for mobile

                // --- Helpers ---
                durationBucketLabel(bucket)
                {
                    const b = Number(bucket ?? 999);
                    if (b === 0) return '< 1h';
                    if (b === 1) return 'â‰ˆ 1h';
                    if (b === 2) return 'â‰ˆ 2h';
                    if (b >= 3 && b < 999) return 'â‰¥ 3h';
                    return 'Unknown';
                },

                // --- Filtering ---
                get filteredWebinars()
                {
                    const term = this.searchTerm.trim().toLowerCase();

                    return this.allWebinars.filter(w =>
                    {
                        // Search
                        if (term)
                        {
                            const haystack = [
                                w.title || '',
                                w.description || '',
                                (w.cysa_tags || []).join(' '),
                                (w.focusAreas || []).join(' ')
                            ].join(' ').toLowerCase();

                            if (!haystack.includes(term))
                            {
                                return false;
                            }
                        }

                        // Duration filter based on duration_bucket
                        const bucket = Number(w.duration_bucket ?? 999);
                        if (this.durationFilter === 'under1' && bucket !== 0) return false;
                        if (this.durationFilter === 'approx1' && bucket !== 1) return false;
                        if (this.durationFilter === 'approx2' && bucket !== 2) return false;
                        if (this.durationFilter === 'three_plus' && bucket < 3) return false;

                        // Watched filter
                        if (this.watchedFilter === 'unwatched' && w.watched) return false;
                        if (this.watchedFilter === 'watched' && !w.watched) return false;

                        // Favorites only
                        if (this.favoritesOnly && !w.favorite) return false;

                        // CySA+ only
                        if (this.cysaOnly && (!w.cysa_tags || w.cysa_tags.length === 0)) return false;

                        return true;
                    });
                },

                // --- Sorting ---
                get sortedWebinars()
                {
                    const list = this.filteredWebinars.slice();

                    if (this.sortMode === 'title')
                    {
                        list.sort((a, b) =>
                            (a.title || '').toLowerCase().localeCompare((b.title || '').toLowerCase())
                        );

                    } else if (this.sortMode === 'watched')
                    {
                        // Unwatched first, then watched; then duration bucket, then title
                        list.sort((a, b) =>
                        {
                            const aw = a.watched ? 1 : 0;
                            const bw = b.watched ? 1 : 0;
                            if (aw !== bw) return aw - bw; // 0 (unwatched) before 1 (watched)

                            const ab = Number(a.duration_bucket ?? 999);
                            const bb = Number(b.duration_bucket ?? 999);
                            if (ab !== bb) return ab - bb;

                            return (a.title || '').toLowerCase().localeCompare((b.title || '').toLowerCase());
                        });

                    } else if (this.sortMode === 'recent_created')
                    {
                        // Newest created first
                        list.sort((a, b) =>
                        {
                            const ac = Number(a.createdAtTimestamp || 0);
                            const bc = Number(b.createdAtTimestamp || 0);

                            if (ac !== bc) return bc - ac; // desc: newest first

                            // tie-breaker: shorter first, then title
                            const ab = Number(a.duration_bucket ?? 999);
                            const bb = Number(b.duration_bucket ?? 999);
                            if (ab !== bb) return ab - bb;

                            return (a.title || '').toLowerCase().localeCompare((b.title || '').toLowerCase());
                        });

                    } else if (this.sortMode === 'relevance')
                    {
                        // Relevance:
                        // 1) CySA+ tagged
                        // 2) favorites
                        // 3) unwatched
                        // 4) newer created
                        // 5) shorter
                        // 6) title
                        list.sort((a, b) =>
                        {
                            const aHasCy = (a.cysa_tags && a.cysa_tags.length) ? 1 : 0;
                            const bHasCy = (b.cysa_tags && b.cysa_tags.length) ? 1 : 0;
                            if (aHasCy !== bHasCy) return bHasCy - aHasCy; // CySA+ first

                            const aFav = a.favorite ? 1 : 0;
                            const bFav = b.favorite ? 1 : 0;
                            if (aFav !== bFav) return bFav - aFav; // favorites next

                            const aw = a.watched ? 1 : 0;
                            const bw = b.watched ? 1 : 0;
                            if (aw !== bw) return aw - bw; // unwatched before watched

                            const ac = Number(a.createdAtTimestamp || 0);
                            const bc = Number(b.createdAtTimestamp || 0);
                            if (ac !== bc) return bc - ac; // newer first

                            const ab = Number(a.duration_bucket ?? 999);
                            const bb = Number(b.duration_bucket ?? 999);
                            if (ab !== bb) return ab - bb; // shorter first

                            return (a.title || '').toLowerCase().localeCompare((b.title || '').toLowerCase());
                        });

                    } else
                    {
                        // Default: duration bucket (0,1,2,3...), THEN createdAt desc, THEN title
                        list.sort((a, b) =>
                        {
                            const ab = Number(a.duration_bucket ?? 999);
                            const bb = Number(b.duration_bucket ?? 999);
                            if (ab !== bb) return ab - bb;

                            const ac = Number(a.createdAtTimestamp || 0);
                            const bc = Number(b.createdAtTimestamp || 0);
                            if (ac !== bc) return bc - ac; // newer first within bucket

                            return (a.title || '').toLowerCase().localeCompare((b.title || '').toLowerCase());
                        });
                    }

                    return list;
                },

                // --- Mutations: calls backend to update state.json ---
                async toggleWatched(w)
                {
                    const newValue = !w.watched;
                    const payload = {
                        webcastId: w.webcastId,
                        watched: newValue,
                    };

                    try
                    {
                        const res = await fetch('/api/toggle-watched', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                        });

                        if (!res.ok)
                        {
                            console.error('Failed to toggle watched', await res.text());
                            return;
                        }

                        w.watched = newValue;
                    } catch (err)
                    {
                        console.error('Error toggling watched', err);
                    }
                },

                async toggleFavorite(w)
                {
                    const newValue = !w.favorite;
                    const payload = {
                        webcastId: w.webcastId,
                        favorite: newValue,
                    };

                    try
                    {
                        const res = await fetch('/api/toggle-favorite', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                        });

                        if (!res.ok)
                        {
                            console.error('Failed to toggle favorite', await res.text());
                            return;
                        }

                        w.favorite = newValue;
                    } catch (err)
                    {
                        console.error('Error toggling favorite', err);
                    }
                },
            };
        }
    </script>
</body>

</html>